# API REST em Rust

API REST desenvolvida em Rust usando Actix-web e SQLx com PostgreSQL para gerenciamento completo de usu√°rios com autentica√ß√£o JWT.

## üöÄ Funcionalidades

- ‚úÖ CRUD completo de usu√°rios
- ‚úÖ Sistema de autentica√ß√£o JWT
- ‚úÖ Roles de usu√°rio (USER/ADMIN)
- ‚úÖ Usu√°rio administrador padr√£o
- ‚úÖ Pagina√ß√£o e busca de usu√°rios
- ‚úÖ Criptografia de senhas com bcrypt
- ‚úÖ Valida√ß√£o de dados e email √∫nico
- ‚úÖ Rate limiting por IP
- ‚úÖ Migra√ß√µes autom√°ticas de banco de dados
- ‚úÖ Testes automatizados completos

## üìã Pr√©-requisitos

- Rust 1.70+ instalado
- PostgreSQL 12+ rodando
- Cargo (vem com o Rust)

## ‚öôÔ∏è Configura√ß√£o

### M√©todo 1: Setup Autom√°tico (Recomendado)
```bash
# Clone o projeto
git clone <url-do-reposit√≥rio>
cd api-rest-rust

# Configure as vari√°veis de ambiente
cp .env.example .env

# Setup completo (instala depend√™ncias, inicia PostgreSQL e executa migra√ß√µes)
make setup
```

### M√©todo 2: Setup Manual
1. **Clone o projeto:**
```bash
git clone <url-do-reposit√≥rio>
cd api-rest-rust
```

2. **Configure as vari√°veis de ambiente:**
```bash
cp .env.example .env
```

3. **Inicie o PostgreSQL com Docker:**
```bash
make docker-up
```

4. **Instale depend√™ncias e execute migra√ß√µes:**
```bash
make install
make migrate
```

## üèÉ‚Äç‚ôÇÔ∏è Como executar

### Usando Makefile (Recomendado)
```bash
# Iniciar servidor
make run

# Ou para desenvolvimento com reload autom√°tico
make watch
```

### Usando Cargo diretamente
```bash
cargo run
```

O servidor estar√° dispon√≠vel em `http://127.0.0.1:8080`

### Comandos √∫teis
```bash
make help          # Ver todos os comandos dispon√≠veis
make check          # Verificar c√≥digo
make test           # Executar testes
make api-test       # Testar endpoints da API
make docker-up      # Iniciar PostgreSQL
make docker-down    # Parar PostgreSQL
```

## üì° Endpoints da API

### üîë Autentica√ß√£o

#### Login
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "email": "usuario@email.com",
  "senha": "senha123"
}
```
**Resposta de sucesso (200):**
```json
{
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "nome": "Jo√£o Silva",
    "email": "joao@email.com",
    "role": "USER",
    "created_at": "2023-12-01T10:30:00Z",
    "updated_at": "2023-12-01T10:30:00Z"
  },
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "expires_at": "2023-12-01T11:30:00Z"
}
```

#### Verificar Token
```http
GET /api/v1/auth/verify/{token}
```

#### Refresh Token
```http
POST /api/v1/auth/refresh/{token}
```

### üîê Rotas Protegidas

As seguintes rotas requerem autentica√ß√£o Bearer Token:

**üîë Autentica√ß√£o JWT Obrigat√≥ria:**
- `GET /api/v1/users/{id}` - Buscar usu√°rio por ID
- `PUT /api/v1/users/{id}` - Atualizar usu√°rio
- `PATCH /api/v1/users/{id}/change-password` - Alterar senha
- `GET /api/v1/users/me` - Dados do usu√°rio logado

**üëë Apenas Administradores:**
- `GET /api/v1/users` - Listar usu√°rios
- `DELETE /api/v1/users/{id}` - Deletar usu√°rio

**üìã Rotas P√∫blicas (sem autentica√ß√£o):**
- `POST /api/v1/auth/login` - Login
- `POST /api/v1/users` - Criar usu√°rio
- `GET /health` - Health check

### üö¶ Rate Limiting

Todos os endpoints t√™m rate limiting aplicado por IP:
- **Limite padr√£o**: 60 requisi√ß√µes por minuto
- **Burst**: 10 requisi√ß√µes em rajada
- **Headers de resposta**: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `Retry-After`
- **Resposta quando limite excedido**: HTTP 429 Too Many Requests

```json
{
  "error": "Rate limit exceeded",
  "message": "Too many requests. Limit: 60 requests per minute",
  "retry_after_seconds": 30
}
```

### üîç Health Check
```http
GET /health
```
**Resposta:**
```json
{
  "status": "ok",
  "message": "API est√° funcionando"
}
```

### üë• CRUD de Usu√°rios

#### 1. Criar Usu√°rio
```http
POST /api/v1/users
POST /api/v1/users/register  (alias)
Content-Type: application/json

{
  "nome": "Jo√£o Silva",
  "email": "joao@exemplo.com",
  "senha": "minhasenha123",
  "role": "USER"
}
```
**Resposta de sucesso (201):**
```json
{
  "message": "Usu√°rio criado com sucesso",
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "nome": "Jo√£o Silva",
    "email": "joao@exemplo.com",
    "role": "USER",
    "created_at": "2023-12-01T10:30:00Z",
    "updated_at": "2023-12-01T10:30:00Z"
  }
}
```

#### 2. Listar Usu√°rios (com pagina√ß√£o e busca)
```http
GET /api/v1/users
GET /api/v1/users?page=1&per_page=10
GET /api/v1/users?search=Jo√£o
GET /api/v1/users?page=2&per_page=5&search=Silva
```
**Par√¢metros de Query:**
- `page` - N√∫mero da p√°gina (padr√£o: 1)
- `per_page` - Usu√°rios por p√°gina (padr√£o: 10, m√°ximo: 100)
- `search` - Busca por nome ou email

**Resposta (200):**
```json
{
  "users": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "nome": "Jo√£o Silva",
      "email": "joao@exemplo.com",
      "role": "USER",
      "created_at": "2023-12-01T10:30:00Z",
      "updated_at": "2023-12-01T10:30:00Z"
    }
  ],
  "total": 1,
  "page": 1,
  "per_page": 10,
  "total_pages": 1
}
```

#### 3. Buscar Usu√°rio por ID
```http
GET /api/v1/users/{id}
```
**Resposta de sucesso (200):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "nome": "Jo√£o Silva",
  "email": "joao@exemplo.com",
  "role": "USER",
  "created_at": "2023-12-01T10:30:00Z",
  "updated_at": "2023-12-01T10:30:00Z"
}
```

#### 4. Atualizar Usu√°rio
```http
PUT /api/v1/users/{id}
Content-Type: application/json

{
  "nome": "Jo√£o Silva Santos",
  "email": "joao.santos@exemplo.com",
  "senha": "novasenha123",  // opcional
  "role": "ADMIN"          // opcional
}
```
**Resposta de sucesso (200):**
```json
{
  "message": "Usu√°rio atualizado com sucesso",
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "nome": "Jo√£o Silva Santos",
    "email": "joao.santos@exemplo.com",
    "role": "ADMIN",
    "created_at": "2023-12-01T10:30:00Z",
    "updated_at": "2023-12-01T10:35:00Z"
  }
}
```

#### 5. Alterar Senha
```http
PATCH /api/v1/users/{id}/change-password
Content-Type: application/json

{
  "senha_atual": "senhaatual123",
  "senha_nova": "novasenha456"
}
```
**Resposta de sucesso (200):**
```json
{
  "message": "Senha alterada com sucesso"
}
```

#### 6. Deletar Usu√°rio
```http
DELETE /api/v1/users/{id}
```
**Resposta de sucesso (200):**
```json
{
  "message": "Usu√°rio deletado com sucesso"
}
```

### ‚ùå Respostas de Erro Comuns

**400 Bad Request:**
```json
{
  "error": "Email j√° est√° em uso"
}
```

**404 Not Found:**
```json
{
  "error": "Usu√°rio n√£o encontrado"
}
```

**422 Unprocessable Entity:**
```json
{
  "error": "Dados inv√°lidos"
}
```

**500 Internal Server Error:**
```json
{
  "error": "Erro interno do servidor"
}
```

## üß™ Testando a API

### Usando script de teste (Recomendado)
```bash
# Certifique-se de que o servidor est√° rodando
make run

# Em outro terminal, execute os testes completos
make api-test

# Se houver problemas, execute diagn√≥stico
make api-diagnose

# Testar rate limiting
make rate-limit-test
```

### Testando autentica√ß√£o

#### Login
```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@sistema.com",
    "senha": "admin123"
  }'
```

#### Verificar token
```bash
curl http://localhost:8080/api/v1/auth/verify/YOUR_JWT_TOKEN_HERE
```

#### Usar token em rotas protegidas
```bash
# Obter dados do usu√°rio logado
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  http://localhost:8080/api/v1/users/me

# Buscar usu√°rio por ID (requer autentica√ß√£o)
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  http://localhost:8080/api/v1/users/USER_ID
```

#### Diagn√≥stico autom√°tico
```bash
# Executar diagn√≥stico da API
make api-diagnose
# ou
./test_api.sh --diagnose
```

### Testando opera√ß√µes CRUD com curl

#### Criar usu√°rio
```bash
curl -X POST http://localhost:8080/api/v1/users \
  -H "Content-Type: application/json" \
  -d '{
    "nome": "Jo√£o Silva",
    "email": "joao@exemplo.com",
    "senha": "minhasenha123",
    "role": "USER"
  }'
```

#### Listar usu√°rios (requer JWT de Admin)
```bash
# Listar todos (precisa ser admin)
curl -H "Authorization: Bearer YOUR_ADMIN_JWT_TOKEN" \
  http://localhost:8080/api/v1/users

# Com pagina√ß√£o (precisa ser admin)
curl -H "Authorization: Bearer YOUR_ADMIN_JWT_TOKEN" \
  "http://localhost:8080/api/v1/users?page=1&per_page=5"

# Com busca (precisa ser admin)
curl -H "Authorization: Bearer YOUR_ADMIN_JWT_TOKEN" \
  "http://localhost:8080/api/v1/users?search=Jo√£o"
```

#### Buscar usu√°rio por ID (requer JWT)
```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  http://localhost:8080/api/v1/users/550e8400-e29b-41d4-a716-446655440000
```

#### Atualizar usu√°rio (requer JWT)
```bash
curl -X PUT http://localhost:8080/api/v1/users/550e8400-e29b-41d4-a716-446655440000 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "nome": "Jo√£o Silva Santos",
    "email": "joao.santos@exemplo.com",
    "role": "ADMIN"
  }'
```

#### Alterar senha (requer JWT)
```bash
curl -X PATCH http://localhost:8080/api/v1/users/550e8400-e29b-41d4-a716-446655440000/change-password \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "senha_atual": "minhasenha123",
    "senha_nova": "novasenha456"
  }'
```

#### Deletar usu√°rio (requer JWT de Admin)
```bash
curl -X DELETE http://localhost:8080/api/v1/users/550e8400-e29b-41d4-a716-446655440000 \
  -H "Authorization: Bearer YOUR_ADMIN_JWT_TOKEN"
```

### Usando PgAdmin
Acesse `http://localhost:8081` para gerenciar o banco:
- **Email:** admin@example.com
- **Senha:** admin123

### üîë Usu√°rio Administrador Padr√£o
- **Email:** admin@sistema.com
- **Senha:** admin123 (ALTERE IMEDIATAMENTE!)
- **Role:** ADMIN

## üèóÔ∏è Estrutura do Projeto

```
api-rest-rust/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mod.rs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.rs      # Configura√ß√£o do banco de dados
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mod.rs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user_handler.rs  # Handlers dos usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mod.rs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.rs          # Modelos de dados
‚îÇ   ‚îî‚îÄ‚îÄ main.rs              # Arquivo principal
‚îú‚îÄ‚îÄ migrations/              # Migra√ß√µes do banco
‚îÇ   ‚îú‚îÄ‚îÄ 20231201000001_create_users_table.up.sql
‚îÇ   ‚îî‚îÄ‚îÄ 20231201000001_create_users_table.down.sql
‚îú‚îÄ‚îÄ docker-compose.yml       # Configura√ß√£o PostgreSQL + PgAdmin
‚îú‚îÄ‚îÄ init.sql                 # Inicializa√ß√£o do banco
‚îú‚îÄ‚îÄ test_api.sh             # Script de testes da API
‚îú‚îÄ‚îÄ Makefile                # Comandos de desenvolvimento
‚îú‚îÄ‚îÄ .env.example            # Exemplo de configura√ß√£o
‚îú‚îÄ‚îÄ Cargo.toml              # Depend√™ncias do projeto
‚îî‚îÄ‚îÄ README.md
```

## üì¶ Depend√™ncias Principais

- **actix-web**: Framework web para Rust
- **sqlx**: Driver ass√≠ncrono para PostgreSQL
- **tokio**: Runtime ass√≠ncrono
- **serde**: Serializa√ß√£o/deserializa√ß√£o JSON
- **bcrypt**: Criptografia de senhas
- **uuid**: Gera√ß√£o de UUIDs
- **chrono**: Manipula√ß√£o de datas
- **dotenv**: Carregamento de vari√°veis de ambiente

## üîê Seguran√ßa

- Senhas s√£o criptografadas usando bcrypt com custo padr√£o
- Valida√ß√£o de email √∫nico no banco de dados
- Uso de UUIDs como identificadores √∫nicos
- Prepared statements para prevenir SQL injection

## üêõ Logs

Os logs s√£o configurados automaticamente. Para ver logs detalhados, execute:

```bash
RUST_LOG=debug cargo run
```

## üöÄ Comandos Make Dispon√≠veis

| Comando | Descri√ß√£o |
|---------|-----------|
| `make help` | Mostra todos os comandos dispon√≠veis |
| `make setup` | Setup completo do projeto |
| `make install` | Instala depend√™ncias |
| `make build` | Compila o projeto |
| `make run` | Executa o servidor |
| `make watch` | Executa com reload autom√°tico |
| `make check` | Verifica c√≥digo |
| `make test` | Executa testes |
| `make api-test` | Testa endpoints da API |
| `make format` | Formata c√≥digo |
| `make lint` | Executa linter |
| `make docker-up` | Inicia PostgreSQL |
| `make docker-down` | Para PostgreSQL |
| `make migrate` | Executa migra√ß√µes |
| `make clean` | Limpa arquivos de build |
| `make api-diagnose` | Diagn√≥stico autom√°tico da API |
| `make rate-limit-test` | Testa funcionalidade de rate limiting |

## ‚úÖ Funcionalidades Implementadas

- ‚úÖ **Autentica√ß√£o JWT completa**
  - Login com email/senha
  - Token JWT com expira√ß√£o
  - Verifica√ß√£o e refresh de tokens
  - **Autentica√ß√£o Bearer Token em rotas protegidas**
- ‚úÖ **Sistema de Roles**
  - USER (usu√°rio comum)
  - ADMIN (administrador)
  - Usu√°rio admin padr√£o criado automaticamente
  - **Middleware de autoriza√ß√£o por role**
- ‚úÖ **CRUD completo de usu√°rios**
  - Criar, listar, buscar, atualizar, deletar
  - Pagina√ß√£o e busca por nome/email
  - Valida√ß√£o de dados e email √∫nico
  - **Rotas protegidas por autentica√ß√£o JWT**
- ‚úÖ **Seguran√ßa robusta**
  - Senhas criptografadas com bcrypt
  - JWT com claims personalizadas
  - Valida√ß√µes de entrada
  - **Controle de acesso por usu√°rio/admin**
  - **Rate limiting por IP com token bucket**
- ‚úÖ **Infraestrutura completa**
  - PostgreSQL com migra√ß√µes autom√°ticas
  - Docker Compose para desenvolvimento
  - Testes automatizados (24+ cen√°rios)
  - Rate limiting testing suite
  - Logs estruturados

## üîí Sistema de Autentica√ß√£o

### Como Funciona

1. **Login:** Usu√°rio faz login com email/senha
2. **Token JWT:** API retorna token JWT v√°lido
3. **Autentica√ß√£o:** Cliente envia token no header `Authorization: Bearer {token}`
4. **Valida√ß√£o:** Middleware valida token em cada requisi√ß√£o
5. **Autoriza√ß√£o:** Sistema verifica permiss√µes baseadas no role do usu√°rio
6. **Rate Limiting:** Sistema controla n√∫mero de requisi√ß√µes por IP

### Rate Limiting

- **Algoritmo:** Token Bucket per IP
- **Configura√ß√£o:** Via vari√°veis de ambiente
- **Headers:** `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `Retry-After`
- **Proxy Support:** Suporte a `X-Forwarded-For` e `X-Real-IP`
- **Testes:** `make rate-limit-test`

### Controle de Acesso

- **Usu√°rios comuns:** Podem ver/editar apenas seus pr√≥prios dados
- **Administradores:** Acesso total a todos os usu√°rios
- **Rotas p√∫blicas:** N√£o requerem autentica√ß√£o
- **Rotas protegidas:** Requerem JWT v√°lido

## üìù Pr√≥ximos Passos

- [x] ~~Middleware de autoriza√ß√£o por role~~
- [x] ~~Endpoints protegidos por JWT~~
- [ ] Implementar soft delete
- [ ] Adicionar valida√ß√£o de email
- [ ] Implementar upload de avatar
- [ ] Adicionar auditoria de mudan√ßas
- [ ] Adicionar documenta√ß√£o Swagger/OpenAPI
- [ ] Implementar rate limiting
- [ ] Adicionar testes unit√°rios e de integra√ß√£o
- [ ] Implementar cache com Redis
- [ ] Adicionar m√©tricas e monitoramento
- [ ] Blacklist de tokens (logout real)
- [ ] Two-factor authentication (2FA)

## üîß Troubleshooting

### Problemas Comuns

**API n√£o responde:**
```bash
make api-diagnose  # Diagn√≥stico autom√°tico
```

**Testes falham:**
```bash
# Verificar se server est√° rodando
curl http://localhost:8080/health

# Executar diagn√≥stico
./test_api.sh --diagnose
```

**Rate limiting n√£o funciona:**
```bash
# Testar rate limiting
make rate-limit-test

# Configurar limites mais baixos (no .env)
RATE_LIMIT_RPM=10
RATE_LIMIT_BURST=3
```

**Token extraction fails:**
- Instale `python3` ou `jq` para melhor parsing JSON
- Se HTTP responses s√£o 200/201, a API est√° funcionando

### Documenta√ß√£o Adicional

- **`AUTH.md`** - Documenta√ß√£o completa de autentica√ß√£o
- **`ROUTES.md`** - Especifica√ß√£o de todas as rotas
- **`API_EXAMPLES.md`** - Exemplos pr√°ticos de uso
- **`EXPECTED_RESPONSES.md`** - Respostas esperadas para troubleshooting
- **`test_rate_limit.sh`** - Testes espec√≠ficos de rate limiting

## ü§ù Contribuindo

1. Fa√ßa um fork do projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo `LICENSE` para mais detalhes.